<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags for Bootstrap-->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png"/>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png"/>
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png"/>
    <!-- Bootstrap CSS -->
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
            crossorigin="anonymous"
    />
    <!-- JS -->
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js"
            integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT"
            crossorigin="anonymous"
    ></script>
    <!-- Vue.js -->
    <!-- development version, includes helpful console warnings -->
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://unpkg.com/vue-router@next"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>Home</title>
</head>
<body class="container">
<div id="app">
    <nav class="navbar bg-light">
        <div class="container-fluid d-flex justify-content-start">
            <div class="navbar-nav p-1">
                <router-link :to="{ name: 'homepage' }" class="btn btn-info"> Home</router-link>
            </div>
            <div class="navbar-nav p-1">
                <router-link :to="{ name: 'data-page' }" class="btn btn-warning"> Data</router-link>
            </div>
            <div class="navbar-nav p-1 ms-auto">
                <router-link :to="{name: 'logout'}" class="btn btn-danger">Sign out</router-link>
            </div>
        </div>
    </nav>
    <router-view></router-view>
</div>
</body>
<script type=" module
                ">
    /*
    * Configure Axios
    */
    axios.defaults.withCredentials = true;
    axios.defaults.baseURL = 'https://localhost:5001/api/';
    const userTokenItemName = 'userToken';

    function lsGetToken(key) {
        const token = localStorage.getItem(userTokenItemName);
        if (!token) {
            console.log('No user token was found in local storage.')
            return undefined;
        }
        return JSON.parse(token);
    }

    function lsSetToken(userToken) {
        if (!userToken) {
            throw new Error("Invalid userToken input.")
        }
        localStorage.setItem(userTokenItemName, JSON.stringify(userToken));
    }

    function lsRemoveToken() {
        localStorage.removeItem(userTokenItemName);
    }

    // TODO: check expiration on access token

    /*
    * Define Components
    */
    const RootComponent = {
        template: `
          <h3>Page loaded at:</h3>
          <pre>{{ dateLoaded }}</pre>
          <div class="card">
          <div class="card-body">
            <h5 class="card-title">Home</h5>
            <p v-if="message" class="card-text">
              {{ message }}
            </p>
            <button v-if="!authenticated" v-on:click="signIn" class="btn btn-primary">
              Sign in
            </button>
            <div v-if="authenticated">
              <p>You're signed in!</p>
              <button v-on:click="clearToken" class="btn btn-info">Clear token</button>
            </div>
            <router-view></router-view>
          </div>
          </div>
        `,
        mounted() {
            this.authenticated = !!lsGetToken();
        },
        data() {
            return {
                dateLoaded: Date(),
                message: null,
                authenticated: Boolean
            };
        },
        methods: {
            signIn() {
                const self = this;
                self.message = 'Signing in...';
                axios
                    // Get Spotify auth URL from API
                    .get('auth')
                    .then(function (response) {
                        try {
                            // redirect to Spotify to sign in
                            window.location.href = response.data;
                            // redirect returns to https://localhost:5001/app/home/login?code=$AUTH_CODE
                            // or https://localhost:5001/app/home/login?error=access_denied&state=STATE
                        } catch (e) {
                            self.message = e;
                        }
                    })
                    .catch(function (error) {
                        self.message = error.message;
                    });
            },
            clearToken() {
                lsRemoveToken();
                this.authenticated = false;
            }
        }
    };

    const PageNotFoundComponent = {
        template: `
                <div class="alert alert-warning" role="alert">
                    <h4 class="alert-heading">404 Page Not Found</h4>
                    <p>Sorry, there's not a page at {{ this.$route.path }}</p>
                </div>
                `,
    };

    const LogoutComponent = {
        template: `
                <div class="alert alert-info" role="alert">
                    <p>Logging out...</p>
                </div>
                `,
        mounted() {
            if (lsGetToken()) {
                lsRemoveToken();
            }
            this.$router.push({name: 'homepage'});
        }
    };

    const LoginComponent = {
        props: ['authCode', 'error', 'state'],
        template: `
          <div v-if='authMessage' class='alert alert-primary'>{{ authMessage }}</div>
          <div v-if='errorMessage' class='alert alert-danger'>{{ errorMessage }}</div>
        `,
        mounted() {
            if (!!lsGetToken()) {
                this.$router.push({name: 'data-page'});
            } else if (this.error) {
                this.showErrorMessage(this.error);
            } else if (this.authCode) {
                this.getAccessToken(this.authCode, this.state);
            } else {
                throw new Error("Either `authCode` or `error` should be populated.")
            }
        },
        data() {
            return {
                authMessage: null,
                errorMessage: null,
            };
        },
        methods: {
            getAccessToken(code, state) {
                this.authMessage = 'Getting authorization code...';
                const self = this;
                axios
                    .post('auth/token', {
                        code: code,
                        state: state,
                    })
                    .then(function (response) {
                        try {
                            self.authMessage = 'Logged in successfully!';
                            lsSetToken(response.data);
                            router.push({name: 'data-page'});
                        } catch (e) {
                            self.errorMessage = e;
                        }
                    })
                    .catch(function (error) {
                        self.errorMessage = error.message;
                    });
            },
            showErrorMessage(error) {
                this.errorMessage = 'Login failed: ' + error;
            },
        },
    };

    const SpotifyDataComponent = {
        template: `
          <div class="card">
          <div class="card-body">
            <h5 class="card-title">Data page</h5>
            <obj-properties-list v-bind:obj="userToken"></obj-properties-list>
            <button v-if="userToken.refreshToken" v-on:click="refreshToken" class="btn btn-info">Refresh
              token
            </button>
            <div v-if='errorMessage' class='alert alert-danger'>{{ errorMessage }}</div>
          </div>
          </div>
          <user-data></user-data>
        `,
        mounted() {
            const token = lsGetToken();
            if (!token) {
                console.log('User does not have a token. Going back to homepage.');
                this.$router.push({name: 'homepage'});
            } else {
                this.userToken = token;
                axios.defaults.headers.common['Authorization'] = this.userToken.accessToken;
            }
        },
        data() {
            return {
                errorMessage: null,
                userToken: {
                    accessToken: String,
                    refreshToken: String,
                    expiration: Date,
                    scopes: Array,
                },
            };
        },
        watch: {
            userToken: function (val) {
                axios.defaults.headers.common['Authorization'] = val.accessToken;
            }
        },
        methods: {
            refreshToken() {
                const self = this;
                axios
                    .post('auth/token/refresh', {
                        refreshToken: this.userToken.refreshToken,
                    })
                    .then(function (response) {
                        try {
                            self.userToken = response.data;
                            lsSetToken(response.data);
                        } catch (e) {
                            self.errorMessage = e;
                        }
                    })
                    .catch(function (error) {
                        self.errorMessage = error.message;
                    });
            },
        },
    };

    const CurrentUserComponent = {
        template: `
          <div class="card">
          <div class="card-body">
            <h5 class="card-title">
              User Profile
            </h5>
            <div class="row">
              <button v-on:click="getUserProfile" class="btn btn-primary col p-2">Get User Profile
              </button>
              <button v-on:click="getUserPlaylists" class="btn btn-secondary col p-2">Get Playlists
              </button>
            </div>
            <obj-properties-list v-if="displayObject" v-bind:obj="displayObject"></obj-properties-list>
            <div v-if="errorMessage" class='alert alert-danger'>{{ errorMessage }}</div>
            <img v-if="userProfile" v-bind:src="userProfile.images[0].url" height="100"
                 alt="user profile pic"
                 class="img-thumbnail">
          </div>
          </div>
        `,
        data() {
            return {
                userProfile: null,
                userPlaylists: null,
                errorMessage: null,
                displayObject: null,
            };
        },
        methods: {
            getUserProfile() {
                const self = this;
                axios
                    .get('user')
                    .then(function (response) {
                        try {
                            self.userProfile = response.data;
                            self.displayObject = self.userProfile;
                        } catch (e) {
                            self.errorMessage = e.message;
                        }
                    })
                    .catch(function (error) {
                        self.errorMessage = error.message;
                    });
            },
            getUserPlaylists() {
                const self = this;
                axios
                    .get('user/playlists')
                    .then(function (response) {
                        try {
                            self.userPlaylists = response.data;
                            self.displayObject = self.userPlaylists;
                        } catch (e) {
                            self.errorMessage = e.message;
                        }
                    })
                    .catch(function (error) {
                        self.errorMessage = error.message;
                    });
            }
        },
    };

    const ObjectPropertiesListComponent = {
        props: ['obj'],
        template: `
          <table class="table table-success table-striped table-bordered text-break">
          <tbody>
          <tr v-for="(value,name) in obj">
            <td>
              <b>{{ name }}</b>
            </td>
            <td style="width:85%">
              {{ value }}
            </td>
          </tr>
          </tbody>
          </table>
        `,
    };

    /*
    * Create Routes and Router
    */
    const routes = [
        {
            path: '/app/home',
            name: 'homepage',
            component: RootComponent,
            children: [
                {
                    path: 'login',
                    name: 'login',
                    component: LoginComponent,
                    props: (route) => ({
                        authCode: route.query.code,
                        error: route.query.error,
                        state: route.query.state
                    }),
                },
            ],
        },
        {path: '/app', redirect: {name: 'homepage'}},
        {
            path: '/app/data',
            name: 'data-page',
            component: SpotifyDataComponent,
            props: true,
        },
        {path: '/logout', name: "logout", component: LogoutComponent},
        {path: '/:pathMatch(.*)*', name: 'page-not-found', component: PageNotFoundComponent},
    ];

    const router = VueRouter.createRouter({history: VueRouter.createWebHistory(), routes});

    /*
    * Create and mount App
    */
    const app = Vue.createApp({});
    app.component('user-data', CurrentUserComponent);
    app.component('obj-properties-list', ObjectPropertiesListComponent);
    app.use(router);
    app.mount('#app');
</script>
</html>
