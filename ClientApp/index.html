<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags for Bootstrap-->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png" />

    <!-- Bootswatch Darkly Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.0.1/dist/darkly/bootstrap.min.css" rel="stylesheet" />
    <!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"-->
    <!--          integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">-->

    <!-- JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js"
      integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT"
      crossorigin="anonymous"
    ></script>
    <!-- Vue.js -->
    <!-- development version, includes helpful console warnings -->
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://unpkg.com/vue-router@next"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <title>Home</title>
  </head>
  <body class="container">
    <div id="app">
      <nav class="navbar bg-dark">
        <div class="container-fluid">
          <router-link :to="{ name: 'homepage' }" class="btn btn-secondary"> Home</router-link>
        </div>
      </nav>
      <router-view></router-view>
    </div>
  </body>
  <script type="module">
    axios.defaults.withCredentials = true;
    axios.defaults.baseURL = 'https://localhost:5001/api/';

    const RootComponent = {
      data() {
        return {
          dateLoaded: Date(),
          message: null,
        };
      },
      methods: {
        signIn() {
          let self = this;
          self.message = 'Signing in...';
          axios
            // Get Spotify auth URL from API
            .get('auth')
            .then(function (response) {
              try {
                // redirect to Spotify to sign in
                window.location.href = response.data;
                // redirect returns to https://localhost:5001/app/login?code=$AUTH_CODE
                // or https://localhost:5001/app/login?error=access_denied&state=STATE
              } catch (e) {
                console.log(e);
                self.message = e;
              }
            })
            .catch(function (error) {
              console.log(error);
              self.message = error.message;
            });
        },
      },
      template: `
          <h3>Page loaded at:</h3>
          <pre>{{ dateLoaded }}</pre>
          <div class="card">
          <div class="card-body">
            <h5 class="card-title">Home</h5>
            <p v-if="message" class="card-text">
              {{ message }}
            </p>
            <button v-on:click="signIn" class="btn btn-primary">
              Sign in
            </button>
          </div>
          </div>
        `,
    };

    const PageNotFoundComponent = {
      template: `
          <div class="alert alert-warning" role="alert">
          <h4 class="alert-heading">404 Page Not Found</h4>
          <p>Sorry, there's not a page at {{ this.$route.path }}</p>
          </div>
        `,
    };

    const LoginComponent = {
      methods: {
        getAccessToken(code, state) {
          console.log(code);
          console.log(state);
          this.authMessage = 'Getting authorization code...';
          let self = this;
          axios
            .post('auth/token', {
              code: code,
              state: state,
            })
            .then(function (response) {
              try {
                self.authMessage = 'Logged in successfully!';
              } catch (e) {
                console.log(e);
                self.errorMessage = e;
              }
            })
            .catch(function (error) {
              console.log(error);
              self.errorMessage = error.message;
            });
        },
        showErrorMessage(error) {
          this.errorMessage = 'Login failed: ' + error;
        },
      },
      data() {
        return {
          authMessage: null,
          errorMessage: null,
        };
      },
      template: `
        <div v-if='authMessage' class='alert alert-primary'>{{authMessage}}</div>
        <div v-if='errorMessage' class='alert alert-danger'>{{errorMessage}}</div>
        `,
      props: ['authCode', 'error', 'state'],
      mounted() {
        if (this.error) {
          this.showErrorMessage(this.error);
        } else if (this.authCode) {
          this.getAccessToken(this.authCode, this.state);
        }
      },
    };

    const routes = [
      { path: '/app/home', name: 'homepage', component: RootComponent },
      { path: '/app', redirect: { name: 'homepage' } },
      {
        path: '/app/login',
        name: 'login',
        component: LoginComponent,
        props: (route) => ({ authCode: route.query.code, error: route.query.error, state: route.query.state }),
      },
      { path: '/:pathMatch(.*)*', name: 'page-not-found', component: PageNotFoundComponent },
    ];
    const router = VueRouter.createRouter({
      history: VueRouter.createWebHistory(),
      routes,
    });

    const app = Vue.createApp({});
    app.use(router);
    app.mount('#app');
  </script>
</html>
